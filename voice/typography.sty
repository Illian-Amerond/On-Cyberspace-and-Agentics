%==============================================================
% typography.sty — Fonts, spacing, lists, captions, code, math
% Requires: LuaLaTeX
%==============================================================
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{typography}[2025/08/09 v0.2 Full Voice typography]

%---------------- Fonts (LuaLaTeX) -----------------------------
\RequirePackage{fontspec}
\defaultfontfeatures{Ligatures=TeX,Renderer=Basic}
% TeX Gyre families are available on Overleaf and print well
\setmainfont[
  Numbers   ={OldStyle,Proportional},
  StylisticSet=1
]{TeX Gyre Pagella}
\setsansfont[Scale=MatchLowercase]{TeX Gyre Heros}
\setmonofont[Scale=MatchLowercase]{Inconsolata}

% Optional: nicer small caps if available
\addfontfeatures{RawFeature={+smcp}} % enable true small caps on demand

%---------------- Micro-typography & math ----------------------
\PassOptionsToPackage{final}{microtype} % protrusion + expansion
\RequirePackage{microtype}

% Math stack: keep mathtools (→ amsmath) first, then unicode-math.
% We silence unicode-math’s “I’m overwriting mathtools colons/brackets” warnings.
\RequirePackage{mathtools}    % loads amsmath
\RequirePackage{unicode-math}
\unimathsetup{warnings-off={mathtools-colon,mathtools-overbracket}}
\setmathfont{TeX Gyre Pagella Math}

%---------------- Layout rhythm --------------------------------
\RequirePackage{setspace}
\setstretch{1.08} % gentle air without bloat
\RequirePackage{parskip}      % space between paragraphs, no first-indent

%---------------- Lists (tight + readable) ----------------------
\RequirePackage{enumitem}
\setlist{nosep,leftmargin=2em,labelsep=0.6em}
\newlist{tightitemize}{itemize}{1}
\setlist[tightitemize]{nosep,leftmargin=1.4em,label=--}

%---------------- Captions -------------------------------------
\RequirePackage{caption}
\captionsetup{
  font=small,
  labelfont=bf,
  labelsep=space,
  textfont=,
  belowskip=6pt,
  aboveskip=8pt
}

%---------------- Code blocks (verbatim aesthetics) -------------
\RequirePackage{fvextra}
\DefineVerbatimEnvironment{code}{Verbatim}{
  breaklines,breakanywhere,fontsize=\small,commandchars=\\\{\},
  frame=single,framesep=3pt,rulecolor=\color{GhostGrayDark}
}

%---------------- Quotation rhythm ------------------------------
\RequirePackage{csquotes}
\SetBlockEnvironment{quote}
\renewenvironment{quote}
  {\list{}{\leftmargin=1.3em\rightmargin=0em}\item\relax\small}
  {\endlist}

%---------------- Section spacing (compact, dignified) ----------
% Visual heading style lives in voice.sty; here we just trim gaps.
\RequirePackage{titlesec}
\titlespacing*{\section}{0pt}{1.25\baselineskip}{0.6\baselineskip}
\titlespacing*{\subsection}{0pt}{1.0\baselineskip}{0.45\baselineskip}
\titlespacing*{\subsubsection}{0pt}{0.8\baselineskip}{0.35\baselineskip}

%---------------- Utility: tight paragraph for callouts ----------
\newenvironment{tightpara}{\vspace{-0.2\baselineskip}\small}{\vspace{-0.2\baselineskip}}

%---------------- Hyphenation & widow control -------------------
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000
\hyphenpenalty=50
\emergencystretch=2em

% Blackboard bold math symbols (e.g., \mathbbm{1})
\RequirePackage{bbm}

% NOTE: Do NOT load cleveref here; load it in the preamble
% AFTER this package (so amsmath/mathtools are already present).

\endinput

% End typography.sty
% ------------------------------------------------------------
% HOW TO USE THIS PACKAGE (typography.sty)
% ------------------------------------------------------------
% Purpose:
%   Provide sane, beautiful defaults for fonts, math, spacing, lists,
%   captions, and references—using LuaLaTeX. Keep voice & color separate.
%
% 1) Engine & Fonts
%   • Compiler: LuaLaTeX (see latexmkrc).
%   • Main: TeX Gyre Pagella (bookish, readable).
%   • Sans: TeX Gyre Heros. Mono: Inconsolata.
%   • Math: TeX Gyre Pagella Math (unicode-math).
%   If you change fonts, do it here—not in document content.
%
% 2) Spacing & Paragraphs
%   • \setstretch{1.08} adds a touch of air.
%   • parskip is enabled (space between paragraphs; no first-line indents).
%   • Use blank lines to separate ideas; avoid manual \vspace in body text.
%
% 3) Lists
%   • enumitem provides compact, readable lists by default.
%   • Use standard environments or the tighter variant:
%       \begin{tightitemize} \item … \end{tightitemize}
%
% 4) Captions & References
%   • Captions are small, bold label + sentence-style text.
%   • Use cleveref for cross-references:
%       \cref{fig:map}  \Cref{sec:intro}
%     Equation refs appear as (1) via \crefformat settings.
%
% 5) Code & Quotations
%   • Code blocks: the 'code' environment (fvextra) wraps long lines.
%       \begin{code} … \end{code}
%   • Quotes are slightly compact; avoid nested quotes where possible.
%
% 6) Section Spacing
%   • titlesec trims vertical gaps for a dignified rhythm.
%   • Visible heading style comes from \Section in voice.sty; do not
%     redefine raw \section formatting in content.
%
% 7) Hyphenation & Widows
%   • Strong widow/orphan penalties are on. If a paragraph still overflows,
%     prefer rephrasing over manual hyphenation.
%
% 8) Good Practices
%   DO:
%     • Keep math operators and delimiters defined in macros/macros.tex.
%     • Use vector PDF/SVG figures; add concise \cap{...} captions.
%     • Keep lines ≲ 100 chars to ease diffs/merges.
%   DON’T:
%     • Hardcode fonts or sizes in content (\large, \small, etc.).
%     • Mix manual spacing commands into prose.
%     • Override hyperlink colors here (voice.sty owns link colors).
%
% 9) Troubleshooting
%   • “Missing font” errors: check compiler is LuaLaTeX.
%   • Bibliography doesn’t appear: ensure biber ran (see latexmkrc).
%   • Weird ref labels: Recompile; latexmk will rerun as needed.
%
% Philosophy:
%   Typography should disappear—the reader feels clarity but sees no effort.
%   Keep content clean; let this package carry the craft.
%
% ------------------------------------------------------------
% End HOW TO USE
